# Cursor Rules for WorkPace Prototypes

## Design System Component Usage

**ALWAYS prefer using components from the published `@workpace/design-system`
npm package before creating custom components.**

### Package Architecture

`@workpace/design-system` is a **published npm package** consumed by `src/` as
an external dependency — NOT as a local workspace symlink. The design-system
source code lives in `design-system/` in this repo for development and
publishing, but `src/` always imports from the **installed published package**.

- **NEVER** import directly from `design-system/src/` or relative paths into the
  design-system source.
- **ALWAYS** import from the published package:
  `import { Button } from '@workpace/design-system'`
- The `design-system/` directory in this repo is **reference only** from
  `src/`'s perspective — use it as documentation and examples of available
  components, their props, variants, and usage patterns.

### Guidelines:

1. **Check Design System First**: Before implementing any UI component, check if
   it exists in the design-system package:
   - Browse `design-system/src/components/` as **documentation/reference** for
     available components, their props, and usage examples
   - Review Storybook stories (`*.stories.tsx`) to understand component variants
     and configurations
   - Check Storybook docs at `design-system/docs/` or run `npm run start` in
     design-system
   - Available components include: Button, Badge, Card, Text, InputField,
     Select, Loading, Divider, Box, and Icons

2. **Using Design System Components**:
   - Always import from the **published package**:
     `import { Button, Card, Text } from '@workpace/design-system'`
   - NEVER import from `design-system/src/...` or `../../design-system/...`
   - Use design system components with their variants and props as documented
   - For navigation links, use polymorphic `as` prop:
     `<Button as={Link} href="/path">Link Text</Button>`
   - If you need to understand a component's API, read its source in
     `design-system/src/components/[ComponentName]/` as reference

3. **New Component Callout**:
   - **If implementing a new component** that's used multiple times or is a
     common UI pattern:
     - ⚠️ **STOP** and check if it should be added to the design-system
     - If the component is used in 2+ places, it should likely be in the
       design-system
     - If the component follows a common UI pattern (buttons, cards, inputs,
       etc.), it belongs in design-system
     - **Ask the user** if they want to add it to the design-system before
       creating a custom implementation
   - New design-system components are only available in `src/` **after** the
     design-system is published to npm and the version is bumped in
     `src/package.json`

4. **Component Addition Process**:
   - When adding a new component to design-system:
     - Create component in `design-system/src/components/[ComponentName]/`
     - Include: `ComponentName.tsx`, `ComponentName.module.scss`, `index.ts`
     - Create Storybook stories in `ComponentName.stories.tsx`
     - Export from `design-system/src/lib.ts`
     - Use design tokens from `@workpace/design-system/dist/design-tokens` for
       styling
     - Follow existing component patterns (polymorphic support, props structure,
       etc.)
   - After adding, remind the user to **publish a new version** via the GitHub
     Actions workflow and update the version in `src/package.json`

5. **Styling**:
   - Use design tokens for colors, spacing, typography:
     `@use '@workpace/design-system/dist/design-tokens' as *;`
   - Follow existing design system patterns for consistency
   - Avoid custom colors/values when design tokens are available

6. **Import Order**:
   - External libraries first
   - Design system imports (`@workpace/design-system`)
   - Internal imports (@/ aliases)
   - Styles

## Design Tokens Reference (SCSS)

**CRITICAL: Only use the EXACT token variable names listed below. Do NOT invent,
guess, or hallucinate token names.**

Import tokens in `.module.scss` files with:

```scss
@use "@workpace/design-system/dist/design-tokens" as *;
```

### Color Tokens

Each color scale has shades: `50, 100, 200, 300, 400, 500, 600, 700, 800, 900`

| Scale       | Variable Pattern         | Example              | Purpose                               |
| ----------- | ------------------------ | -------------------- | ------------------------------------- |
| **neutral** | `$color-neutral-{shade}` | `$color-neutral-500` | Grays, text, backgrounds, borders     |
| **primary** | `$color-primary-{shade}` | `$color-primary-500` | Brand blue, primary actions           |
| **success** | `$color-success-{shade}` | `$color-success-500` | Positive states, confirmations        |
| **warning** | `$color-warning-{shade}` | `$color-warning-500` | Caution states, alerts                |
| **error**   | `$color-error-{shade}`   | `$color-error-500`   | Destructive, invalid, critical states |
| **info**    | `$color-info-{shade}`    | `$color-info-500`    | Informational states                  |
| **active**  | `$color-active-{shade}`  | `$color-active-500`  | Active/selected states (orange)       |
| **accent**  | `$color-accent-{shade}`  | `$color-accent-500`  | Accent color (deep blue)              |

Special neutrals: `$color-neutral-black`, `$color-neutral-white`

**⚠️ Common mistakes — these token names DO NOT EXIST:**

- ~~`$color-urgent-*`~~ → use `$color-error-*`
- ~~`$color-danger-*`~~ → use `$color-error-*`
- ~~`$color-destructive-*`~~ → use `$color-error-*`
- ~~`$color-red-*`~~ → use `$color-error-*`
- ~~`$color-green-*`~~ → use `$color-success-*`
- ~~`$color-blue-*`~~ → use `$color-primary-*` or `$color-info-*`
- ~~`$color-yellow-*`~~ → use `$color-warning-*`
- ~~`$color-orange-*`~~ → use `$color-active-*`
- ~~`$color-gray-*`~~ / ~~`$color-grey-*`~~ → use `$color-neutral-*`
- ~~`$color-secondary-*`~~ → use `$color-accent-*`
- ~~`$color-disabled-*`~~ → does not exist, use `$color-neutral-*` shades
- ~~`$color-dark-*`~~ / ~~`$color-light-*`~~ → does not exist, use appropriate
  scale shades

### Size / Spacing Tokens

`$size-25` (2px), `$size-50` (4px), `$size-75` (6px), `$size-100` (8px),
`$size-125` (10px), `$size-150` (12px), `$size-200` (16px), `$size-250` (20px),
`$size-300` (24px), `$size-400` (32px), `$size-500` (40px), `$size-600` (48px),
`$size-700` (56px), `$size-800` (64px), `$size-900` (72px)

### Typography Tokens

- **Font stack**: `$font-family`, `$font-stack`
- **Weights**: `$font-weight-regular` (400), `$font-weight-medium` (500),
  `$font-weight-bold` (700), `$font-weight-emphasis` (500),
  `$font-weight-default` (400)
- **Headlines**: `$font-headline-{display|lg|md|sm}-font-size`,
  `$font-headline-{display|lg|md|sm}-line-height`
- **Body**: `$font-body-{lg|md|sm|xs}-font-size`,
  `$font-body-{lg|md|sm|xs}-line-height`,
  `$font-body-{lg|md|sm|xs}-paragraph-line-height`
- **Button**: `$font-button-{md|sm}-font-size`,
  `$font-button-{md|sm}-line-height`,
  `$font-button-font-weight-{default|emphasis}`

### Breakpoint & Media Query Tokens

- **Breakpoints**: `$breakpoints-sm` (1px), `$breakpoints-md` (640px),
  `$breakpoints-lg` (1024px), `$breakpoints-xl` (1280px)
- **Media queries**: `$mq-sm-only`, `$mq-md-up`, `$mq-lg-up`, `$mq-xl-up`,
  `$mq-phone-landscape-only`

### Icon Size Tokens

`$icons-sm` (16px), `$icons-md` (20px), `$icons-lg` (24px)

## Layout Architecture

### Overview

The app uses a layered layout system managed in `src/layout/`. Pages are
composed from these layers in `src/pages/_app.tsx`:

| Route Pattern              | Layout                            | PageHeader | Auth Overlay |
| -------------------------- | --------------------------------- | ---------- | ------------ |
| `/` (landing)              | Own `StandardNavbar` + custom     | No         | No           |
| `/signin`                  | No layout (standalone)            | No         | No           |
| `/prototypes`              | `MainLayout`                      | Yes        | Yes          |
| `/design-system`           | `MainLayout`                      | Yes        | No           |
| `/system-design`           | `MainLayout`                      | Yes        | No           |
| `/prototypes/ralli` (etc.) | `MainLayout` + `SubNavbar` active | No         | Yes          |

### MainLayout (`src/layout/MainLayout/`)

`MainLayout` is the common wrapper for all non-landing, non-signin pages. It
provides:

- **`StandardNavbar`** — Fixed top navbar (`position: fixed`, ~72px, z-index:
  1000)
- **`SubNavbar`** — Fixed sub-navigation (`position: fixed`, top: 72px, ~48px)
  that only renders on individual prototype pages (e.g. `/prototypes/ralli`).
  Returns `null` on all other pages.
- **Content area** — Uses `padding-top` (not a spacer div) to offset below fixed
  navbars:
  - `72px` when only StandardNavbar is visible
  - `120px` when SubNavbar is also active
- **`AuthOverlay`** — Wraps the content area for unauthenticated users on
  protected routes. Covers the full viewport below the navbar with no gap.

**CRITICAL: NEVER use a spacer div for navbar offset.** Always use `padding-top`
on the content container. This ensures overlays and full-height content can
reach the navbar edge.

```
pageLayout (flex column, min-height: 100vh)
  StandardNavbar (fixed)
  SubNavbar (fixed, conditional)
  pageContent (padding-top: 72px / 120px, flex: 1)
    → AuthOverlay wraps here when unauthenticated
    → children
```

### PageHeader (`src/layout/PageHeader/`)

A reusable page title component for pages that share a consistent header
pattern. **Separate from MainLayout** — pages opt in by including it.

```tsx
import { PageHeader } from "@/layout/PageHeader";

<PageHeader title="Page Title" subtitle="Optional subtitle text" />;
```

- Used by: `/prototypes`, `/design-system`, `/system-design`
- NOT used by: `/prototypes/ralli` (has custom layout), landing page, signin
- Props: `title: string`, `subtitle?: string`
- Renders a max-width container with consistent typography and a bottom border

### Adding New Pages

1. **Standard page with header**: Add `<PageHeader>` at the top of your page
   component. MainLayout handles the navbar and spacing automatically.
2. **Custom layout page** (like `/prototypes/ralli`): Just render your content
   directly — MainLayout still handles the navbar offset via `padding-top`.
3. **Public page** (no auth overlay): Add the pathname to `shouldShowOverlay`
   exclusion list in `MainLayout`.
4. **Page with SubNavbar**: SubNavbar auto-detects prototype sub-pages from the
   `PROTOTYPES` array in `src/interfaces/prototypes.ts`. Add your prototype
   there and the SubNavbar + padding adjustment happens automatically.

### AuthOverlay (`src/components/AuthOverlay/`)

Shows a blurred content preview with a "Sign In" prompt for unauthenticated
users on protected routes. It wraps the content area inside MainLayout using
`flex: 1` to fill the remaining viewport. The overlay is absolutely positioned
within the wrapper, covering the full area. The fixed navbar (z-index: 1000)
sits above the overlay (z-index: 10).

## Supabase Database & Migrations

**NEVER use Supabase MCP tools (`apply_migration`, `execute_sql`) to modify the
remote database schema or migration history.** The ONLY allowed ways to update
Supabase are:

1. **`npm run supabase:diff:local`** — Generate a migration by diffing local
   shadow DB against declared schemas in `./supabase/schemas/`.
2. **`npm run supabase:push`** — Push local migrations to the remote database.

### Rules:

- **Schema changes** go in declarative SQL files under `./supabase/schemas/`.
  These define the desired final state.
- **Migrations** are generated automatically via `npm run supabase:diff:local` —
  NEVER write migration files by hand or via MCP tools.
- **Pushing** migrations to remote is done ONLY via `npm run supabase:push` —
  NEVER use `mcp_supabase_apply_migration` or `mcp_supabase_execute_sql` for
  DDL/schema changes.
- You MAY use `mcp_supabase_execute_sql` for **read-only queries** (e.g.,
  `SELECT` statements to inspect data) but NEVER for writes, DDL, or schema
  modifications.
- You MAY use `mcp_supabase_list_tables`, `mcp_supabase_list_migrations`,
  `mcp_supabase_get_advisors`, and other read-only MCP tools for inspection.
- If a migration needs to be repaired, inform the user and let them run the
  repair commands manually.

### Schema File Ordering (CRITICAL)

Supabase applies schema files in **lexicographic (alphabetical) order** when
running `supabase db diff`. This means if schema file `apps.sql` references a
function defined in `good_things.sql`, it will **fail** because `a` sorts before
`g` and the function doesn't exist yet when `apps.sql` runs.

**Rules to prevent ordering bugs:**

1. **Shared functions** (e.g. `update_updated_at_column()`) MUST live in
   `supabase/schemas/_functions.sql`. The `_` prefix ensures it sorts before all
   letter-named files, so functions are always available.
2. **NEVER define shared functions inside individual table schema files.** If a
   function is used by more than one table, it belongs in `_functions.sql`.
3. **NEVER duplicate function definitions** across schema files with
   `CREATE OR REPLACE` as a workaround — this is fragile and error-prone.
4. **Table dependencies**: If table B has a foreign key to table A, name the
   files so A sorts before B (e.g. `good_things.sql` before
   `good_things_media.sql`). If naming alone can't solve it, use the
   `schema_paths` array in `supabase/config.toml` to set explicit ordering.
5. **When creating a new schema file**, always check: does this schema reference
   any function or table defined in another file? If so, verify the alphabetical
   order is correct.

**Current shared functions in `_functions.sql`:**

- `update_updated_at_column()` — used by: `apps`, `consultation_requests`,
  `events`, `event_guests`, `goals`, `good_things`, `notion_templates`,
  `saved_reports`

## Code Style

- Use TypeScript strictly
- Prefer functional components with hooks
- Use design system components as the foundation
- Follow existing file structure patterns
- Maintain consistent naming conventions
