name: Release Design System to NPM

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch
      branch:
        description: 'Branch to release from'
        required: true
        type: string
        default: 'main'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # Don't set registry-url to avoid token authentication
          # OIDC will be used automatically by npm publish

      - name: Upgrade npm for trusted publishing
        run: |
          # Trusted publishing requires npm 11.5.1+
          CURRENT_NPM=$(npm --version)
          echo "Current npm version: $CURRENT_NPM"
          npm install -g npm@latest
          NEW_NPM=$(npm --version)
          echo "Upgraded npm version: $NEW_NPM"
          # Verify we have at least npm 11.5.1
          MAJOR=$(echo $NEW_NPM | cut -d. -f1)
          MINOR=$(echo $NEW_NPM | cut -d. -f2)
          PATCH=$(echo $NEW_NPM | cut -d. -f3)
          if [ "$MAJOR" -lt 11 ] || ([ "$MAJOR" -eq 11 ] && [ "$MINOR" -lt 5 ]) || ([ "$MAJOR" -eq 11 ] && [ "$MINOR" -eq 5 ] && [ "$PATCH" -lt 1 ]); then
            echo "ERROR: npm version must be 11.5.1 or later for trusted publishing. Current: $NEW_NPM"
            exit 1
          fi
          echo "âœ“ npm version $NEW_NPM meets trusted publishing requirements"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        working-directory: ./design-system
        run: npm ci

      - name: Build design system
        working-directory: ./design-system
        run: npm run build:production

      - name: Bump version
        working-directory: ./design-system
        run: |
          npm version ${{ inputs.version_type }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "Bumped version to $NEW_VERSION"

      - name: Publish to NPM
        working-directory: ./design-system
        env:
          # Explicitly unset any token to force OIDC usage
          NODE_AUTH_TOKEN: ''
          NPM_TOKEN: ''
        run: |
          # Configure registry for OIDC (trusted publishing)
          npm config set registry https://registry.npmjs.org/
          # Remove any token-based auth that might have been set
          npm config delete //registry.npmjs.org/:_authToken || true
          # Remove any .npmrc files that might contain tokens
          rm -f .npmrc ~/.npmrc $HOME/.npmrc || true
          echo "Publishing with OIDC trusted publishing (no token needed)..."
          npm publish --access public

      - name: Commit version bump
        run: |
          git add design-system/package.json design-system/package-lock.json
          git commit -m "chore: bump design-system version to ${{ env.NEW_VERSION }}"
          git push origin HEAD:${{ inputs.branch }}

      - name: Create git tag
        run: |
          git tag -a "design-system/v${{ env.NEW_VERSION }}" -m "Release design-system v${{ env.NEW_VERSION }}"
          git push origin "design-system/v${{ env.NEW_VERSION }}"

